---
phase: 03-polish
plan: 01
type: execute
---

<objective>
Handle scanner edge cases, add progress feedback for the enhanced scan, and verify end-to-end.

Purpose: The enhanced scan makes more API calls per repo, so it's slower. Users need feedback. Edge cases (archived, empty, private, rate-limited) need graceful handling.
Output: Robust scanner with progress output, edge case handling, and passing build.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
@~/.claude/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/01-scanner-source/01-02-SUMMARY.md
@.planning/phases/02-dashboard-source/02-02-SUMMARY.md
@scanner/index.ts
@scanner/github.ts
@scanner/diff.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edge case handling and progress feedback to scanner</name>
  <files>scanner/index.ts, scanner/github.ts</files>
  <action>
  **Edge case handling in scanner/github.ts:**
  - Archived repos: `fetchRepoLanguages` should handle 403 responses (archived repos may block API calls). Return empty `{}` on failure.
  - Empty repos: repos with no commits will have `pushed_at: null` and may fail on branch/commit API calls. Already handled by existing `.catch(() => 0)` patterns — verify languages call also has this pattern.
  - Rate limiting: add a simple check after each API response. If `x-ratelimit-remaining` header is below 10, log a warning: "GitHub API rate limit running low: {remaining} requests left". Don't block — just warn. Access rate limit from `octokit.rateLimit.get()` or from response headers.
  - Fork repos: no special handling needed (already captured as `isFork` flag), but log a count: "Found X forks" in the summary.

  **Progress feedback in scanner/index.ts:**
  - Before the main loop, log: "Enriching {N} repos (fetching languages, computing diffs for local repos)..."
  - Change the existing progress log from every 10 repos to every 5 repos (more API calls = slower = more frequent feedback needed)
  - After each synced repo diff computation, log: "  Computing local-remote diff for {name}..."
  - At the end, log a source summary:
    ```
    Source breakdown:
      Local only: X
      Remote only: X
      Synced: X
    ```

  **Manifest backward compatibility:**
  - Ensure the new fields in manifest.json have sensible defaults so the dashboard doesn't crash if someone runs an old scan:
    - `source` defaults to `'remote-only'` (conservative assumption)
    - `languages` defaults to `{}`
    - `topics` defaults to `[]`
    - `diff` defaults to `null`
    - Other new fields: `visibility: null`, `license: null`, `sizeKB: 0`, `isArchived: false`, `isFork: false`
  </action>
  <verify>npx tsc --noEmit succeeds. npx vitest run passes all tests.</verify>
  <done>Scanner handles archived/empty/rate-limited repos gracefully, logs progress every 5 repos, prints source breakdown at end, manifest has backward-compatible defaults</done>
</task>

<task type="auto">
  <name>Task 2: Add defensive rendering in dashboard for missing new fields</name>
  <files>src/components/ProjectDetail.tsx, src/components/ProjectTable.tsx, src/components/SummaryCards.tsx, src/components/SourceBadge.tsx</files>
  <action>
  Add defensive checks in dashboard components so they handle manifests that were generated before this feature (backward compatibility):

  1. **SourceBadge**: if `source` is undefined/null, render a gray "Unknown" badge instead of crashing.

  2. **ProjectTable**: if `project.source` is undefined, treat it as 'remote-only' for filtering purposes. The source filter should still work even with old manifest data.

  3. **SummaryCards**: if no projects have a `source` field, hide the source breakdown row entirely (don't show zeros).

  4. **ProjectDetail**:
     - Source & Remote Metadata section: only render if at least one of the new fields exists
     - Languages bar: only render if `languages` exists and has entries
     - Topics: only render if `topics` exists and has entries
     - Diff section: already guarded by `project.diff !== null` — add an additional guard for `project.diff !== undefined`

  This ensures the dashboard works with both old and new manifest formats without errors.
  </action>
  <verify>npm run build succeeds. Dashboard loads without errors with the current (old-format) manifest.json.</verify>
  <done>Dashboard renders gracefully with both old-format and new-format manifests. No crashes, no blank sections for missing data.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full remote repo visibility feature: scanner source classification, enhanced GitHub metadata, local-vs-remote diff, updated dashboard with source badges, filters, metadata display, and diff section.</what-built>
  <how-to-verify>
    1. Run: npm run scan (with GITHUB_TOKEN and GITHUB_USERNAME set)
    2. Check scanner output for: source breakdown, progress logs, no errors
    3. Run: npm run dev
    4. Visit: http://localhost:3000
    5. Verify: Summary cards show Local/Remote/Synced counts
    6. Verify: Project table has Source column with colored badges
    7. Verify: Source filter dropdown works (try "Remote only")
    8. Click a remote-only project: verify languages bar, topics, visibility, license shown
    9. Click a synced project (if any): verify diff section shows ahead/behind, branch info
    10. Verify: No visual regressions in existing dashboard features
  </how-to-verify>
  <resume-signal>Type "approved" to complete, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds
- [ ] `npx vitest run` passes all tests
- [ ] `npm run scan` completes without errors and shows source breakdown
- [ ] Dashboard renders correctly with new manifest data
- [ ] Old manifests don't crash the dashboard
</verification>

<success_criteria>
- Scanner handles all edge cases gracefully
- Progress feedback shown during scan
- Dashboard backward-compatible with old manifests
- End-to-end feature works: scan → view source badges → filter → detail page
- Phase 03 complete — feature ready for merge
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish/03-01-SUMMARY.md`
</output>
